# Phase 2：uniCloud 云数据库设计文档（阿里云）

## 一、集合字段设计

### 1. robots 集合（机器人基础信息）

| 字段名 | 类型 | 说明 | 示例值 |
|--------|------|------|--------|
| `_id` | String | 系统自动生成 | `"65a1b2c3d4e5f6g7h8i9j0k1"` |
| `robotCode` | String | 机器人编号（唯一） | `"ROBOT-001"` |
| `model` | String | 机器人型号 | `"AGV-2000"` |
| `online` | Boolean | 在线状态 | `true` / `false` |
| `location` | Object | 位置信息 | `{ x: 120.5, y: 30.2 }` |
| `location.x` | Number | X坐标 | `120.5` |
| `location.y` | Number | Y坐标 | `30.2` |
| `createTime` | Timestamp | 创建时间 | `1705291825000` |
| `updateTime` | Timestamp | 更新时间 | `1705291825000` |

**索引建议：**
- `robotCode`：唯一索引（Unique Index）

---

### 2. telemetry_latest 集合（最新遥测数据）

| 字段名 | 类型 | 说明 | 示例值 |
|--------|------|------|--------|
| `_id` | String | 系统自动生成 | `"65a1b2c3d4e5f6g7h8i9j0k2"` |
| `robotCode` | String | 机器人编号（关联 robots） | `"ROBOT-001"` |
| `vehicleBattery` | Number | 车体电量（0-100） | `85.5` |
| `packBattery` | Number | 电池包电量（0-100） | `92.3` |
| `lastSeen` | String | 最后在线时间 | `"2024-01-15 14:30:25"` |
| `ts` | Timestamp | 时间戳（用于排序） | `1705291825000` |
| `createTime` | Timestamp | 创建时间 | `1705291825000` |
| `updateTime` | Timestamp | 更新时间 | `1705291825000` |

**索引建议：**
- `robotCode`：普通索引（用于查询）
- `ts`：降序索引（用于获取最新数据）

---

### 3. faults 集合（故障记录）

| 字段名 | 类型 | 说明 | 示例值 |
|--------|------|------|--------|
| `_id` | String | 系统自动生成 | `"65a1b2c3d4e5f6g7h8i9j0k3"` |
| `robotCode` | String | 机器人编号（关联 robots） | `"ROBOT-001"` |
| `code` | String | 故障代码 | `"F001"` |
| `message` | String | 故障信息 | `"电池温度异常"` |
| `status` | String | 故障状态 | `"active"` / `"resolved"` |
| `time` | String | 故障发生时间 | `"2024-01-15 13:20:00"` |
| `ts` | Timestamp | 时间戳（用于排序和索引） | `1705288800000` |
| `createTime` | Timestamp | 创建时间 | `1705288800000` |
| `updateTime` | Timestamp | 更新时间 | `1705288800000` |

**索引建议：**
- 复合索引：`robotCode` + `ts`（降序）
  - 用于快速查询某机器人的故障记录，按时间倒序

---

### 4. commands 集合（控制命令）

| 字段名 | 类型 | 说明 | 示例值 |
|--------|------|------|--------|
| `_id` | String | 系统自动生成 | `"65a1b2c3d4e5f6g7h8i9j0k4"` |
| `robotCode` | String | 机器人编号（关联 robots） | `"ROBOT-001"` |
| `type` | String | 命令类型 | `"direction"` / `"position"` |
| `action` | String | 具体动作 | `"forward"` / `"backward"` / `"left"` / `"right"` / `"stop"` / `"goto"` |
| `params` | Object | 命令参数 | `{ x: 120.5, y: 30.2 }` 或 `{}` |
| `status` | String | 命令状态 | `"pending"` / `"executing"` / `"completed"` / `"failed"` |
| `ts` | Timestamp | 时间戳（用于排序和索引） | `1705291825000` |
| `createTime` | Timestamp | 创建时间 | `1705291825000` |
| `updateTime` | Timestamp | 更新时间 | `1705291825000` |

**索引建议：**
- 复合索引：`robotCode` + `ts`（降序）
  - 用于快速查询某机器人的命令历史，按时间倒序

---

## 二、索引设计总结

### robots 集合
- ✅ `robotCode`：唯一索引（Unique）

### telemetry_latest 集合
- ✅ `robotCode`：普通索引
- ✅ `ts`：降序索引

### faults 集合
- ✅ 复合索引：`robotCode`（升序）+ `ts`（降序）

### commands 集合
- ✅ 复合索引：`robotCode`（升序）+ `ts`（降序）

---

## 三、uniCloud 控制台操作步骤

### 步骤 1：进入 uniCloud 控制台

1. 访问：https://unicloud.dcloud.net.cn/
2. 登录 DCloud 账号
3. 选择对应的服务空间（阿里云）

### 步骤 2：创建集合

1. 在左侧菜单选择「云数据库」→「数据库」
2. 点击「新建集合」按钮
3. 依次创建以下 4 个集合：
   - `robots`
   - `telemetry_latest`
   - `faults`
   - `commands`

### 步骤 3：创建索引

#### robots 集合索引
1. 进入 `robots` 集合
2. 点击「索引」标签页
3. 点击「新建索引」
4. 索引名称：`robotCode_unique`
5. 索引字段：`robotCode`（升序）
6. 勾选「唯一索引」
7. 点击「确定」

#### telemetry_latest 集合索引
1. 进入 `telemetry_latest` 集合
2. 创建索引 1：
   - 索引名称：`robotCode_idx`
   - 索引字段：`robotCode`（升序）
3. 创建索引 2：
   - 索引名称：`ts_desc_idx`
   - 索引字段：`ts`（降序）

#### faults 集合索引
1. 进入 `faults` 集合
2. 点击「新建索引」
3. 索引名称：`robotCode_ts_idx`
4. 索引字段：
   - `robotCode`（升序）
   - `ts`（降序）
5. 点击「确定」

#### commands 集合索引
1. 进入 `commands` 集合
2. 点击「新建索引」
3. 索引名称：`robotCode_ts_idx`
4. 索引字段：
   - `robotCode`（升序）
   - `ts`（降序）
5. 点击「确定」

### 步骤 4：插入初始化数据

1. 进入对应集合（如 `robots`）
2. 点击「数据」标签页
3. 点击「添加数据」或「导入数据」
4. 选择「JSON 格式」
5. 复制下方提供的初始化 JSON 数据
6. 粘贴到输入框
7. 点击「确定」或「导入」

---

## 四、初始化 JSON 数据

### robots 集合初始化数据

```json
[
  {
    "robotCode": "ROBOT-001",
    "model": "AGV-2000",
    "online": true,
    "location": {
      "x": 120.5,
      "y": 30.2
    },
    "createTime": 1705291825000,
    "updateTime": 1705291825000
  },
  {
    "robotCode": "ROBOT-002",
    "model": "AGV-2000",
    "online": true,
    "location": {
      "x": 120.6,
      "y": 30.3
    },
    "createTime": 1705291825000,
    "updateTime": 1705291825000
  }
]
```

### telemetry_latest 集合初始化数据

```json
[
  {
    "robotCode": "ROBOT-001",
    "vehicleBattery": 85.5,
    "packBattery": 92.3,
    "lastSeen": "2024-01-15 14:30:25",
    "ts": 1705291825000,
    "createTime": 1705291825000,
    "updateTime": 1705291825000
  },
  {
    "robotCode": "ROBOT-002",
    "vehicleBattery": 65.8,
    "packBattery": 78.9,
    "lastSeen": "2024-01-15 14:28:10",
    "ts": 1705291681000,
    "createTime": 1705291681000,
    "updateTime": 1705291681000
  }
]
```

### faults 集合初始化数据

```json
[
  {
    "robotCode": "ROBOT-001",
    "code": "F001",
    "message": "电池温度异常",
    "status": "active",
    "time": "2024-01-15 13:20:00",
    "ts": 1705288800000,
    "createTime": 1705288800000,
    "updateTime": 1705288800000
  },
  {
    "robotCode": "ROBOT-002",
    "code": "F002",
    "message": "通信延迟",
    "status": "active",
    "time": "2024-01-15 13:25:00",
    "ts": 1705289100000,
    "createTime": 1705289100000,
    "updateTime": 1705289100000
  },
  {
    "robotCode": "ROBOT-002",
    "code": "F003",
    "message": "传感器故障",
    "status": "resolved",
    "time": "2024-01-15 12:00:00",
    "ts": 1705284000000,
    "createTime": 1705284000000,
    "updateTime": 1705290000000
  }
]
```

### commands 集合初始化数据（可选）

```json
[
  {
    "robotCode": "ROBOT-001",
    "type": "direction",
    "action": "forward",
    "params": {},
    "status": "completed",
    "ts": 1705291800000,
    "createTime": 1705291800000,
    "updateTime": 1705291810000
  },
  {
    "robotCode": "ROBOT-002",
    "type": "position",
    "action": "goto",
    "params": {
      "x": 120.7,
      "y": 30.4
    },
    "status": "executing",
    "ts": 1705291900000,
    "createTime": 1705291900000,
    "updateTime": 1705291900000
  }
]
```

---

## 五、验收标准与验证方法

### 验收标准

1. ✅ 四个集合已创建
2. ✅ 所有索引已创建
3. ✅ 初始化数据已插入（至少 2 台机器人）
4. ✅ 数据关联正确（robotCode 一致）
5. ✅ 可通过查询验证数据完整性

### 验证方法

#### 方法 1：在 uniCloud 控制台验证

1. **验证 robots 集合**
   - 进入 `robots` 集合 → 「数据」标签页
   - 应看到至少 2 条记录
   - 检查 `robotCode` 字段值：`ROBOT-001`、`ROBOT-002`

2. **验证 telemetry_latest 集合**
   - 进入 `telemetry_latest` 集合 → 「数据」标签页
   - 应看到至少 2 条记录
   - 检查 `robotCode` 与 robots 集合对应
   - 检查 `vehicleBattery`、`packBattery` 为数字类型

3. **验证 faults 集合**
   - 进入 `faults` 集合 → 「数据」标签页
   - 应看到至少 2 条记录
   - 检查 `robotCode` 与 robots 集合对应
   - 检查 `code`、`message` 字段有值

4. **验证 commands 集合**（可选）
   - 进入 `commands` 集合 → 「数据」标签页
   - 检查命令记录格式正确

5. **验证索引**
   - 进入各集合 → 「索引」标签页
   - 检查索引已创建且配置正确

#### 方法 2：使用 JQL 文件验证

在项目中的 `uniCloud-aliyun/database/JQL file Name.jql` 文件中执行以下查询：

```javascript
// 1. 查询所有机器人
db.collection('robots').get();

// 2. 查询机器人 ROBOT-001 的详细信息
db.collection('robots').where({
  robotCode: 'ROBOT-001'
}).get();

// 3. 查询机器人 ROBOT-001 的最新遥测数据
db.collection('telemetry_latest').where({
  robotCode: 'ROBOT-001'
}).orderBy('ts', 'desc').limit(1).get();

// 4. 查询机器人 ROBOT-001 的所有故障（按时间倒序）
db.collection('faults').where({
  robotCode: 'ROBOT-001'
}).orderBy('ts', 'desc').get();

// 5. 查询机器人 ROBOT-001 的活跃故障
db.collection('faults').where({
  robotCode: 'ROBOT-001',
  status: 'active'
}).get();

// 6. 查询机器人 ROBOT-001 的命令历史（按时间倒序）
db.collection('commands').where({
  robotCode: 'ROBOT-001'
}).orderBy('ts', 'desc').get();

// 7. 关联查询：获取机器人及其最新遥测数据
db.collection('robots').aggregate()
  .lookup({
    from: 'telemetry_latest',
    localField: 'robotCode',
    foreignField: 'robotCode',
    as: 'telemetry'
  })
  .end();
```

#### 方法 3：验证数据关联性

执行以下查询验证数据关联：

```javascript
// 验证：每个机器人都有对应的遥测数据
db.collection('robots').get().then(res => {
  const robotCodes = res.data.map(r => r.robotCode);
  return db.collection('telemetry_latest')
    .where({
      robotCode: db.command.in(robotCodes)
    })
    .get();
});

// 验证：统计每个机器人的故障数量
db.collection('faults').aggregate()
  .group({
    _id: '$robotCode',
    count: $.sum(1)
  })
  .end();
```

### 预期结果

- ✅ robots 集合：至少 2 条记录
- ✅ telemetry_latest 集合：至少 2 条记录，robotCode 与 robots 对应
- ✅ faults 集合：至少 2 条记录，robotCode 与 robots 对应
- ✅ 所有查询能正常返回数据
- ✅ 索引查询性能正常

---

## 六、注意事项

1. **时间戳格式**：uniCloud 阿里云使用毫秒级时间戳（Number 类型）
2. **唯一性约束**：`robots.robotCode` 必须唯一，创建唯一索引
3. **数据关联**：通过 `robotCode` 字段关联各集合数据
4. **索引顺序**：复合索引中，`robotCode` 在前，`ts` 在后，且 `ts` 为降序
5. **导入数据**：如果使用「导入数据」功能，确保 JSON 格式正确，不要包含 `_id` 字段（系统自动生成）

---

**Phase 2 完成标志**：所有集合创建完成，索引配置正确，初始化数据已插入，可通过查询验证数据完整性。
